# Условное отображение Sidebar

## Описание

Реализована новая функциональность для условного отображения Sidebar на основе текущего маршрута пользователя.

## Что изменилось

### До изменений

- Sidebar отображался на всех страницах (кроме auth страниц)
- Нет логики для скрытия Sidebar на определенных страницах

### После изменений

- Sidebar показывается только на определенных маршрутах
- Автоматически скрывается на auth страницах
- Легко настраивается список маршрутов для показа Sidebar
- **Решена проблема с гидратацией** - Sidebar показывается при первой отрисовке

## Архитектура

### 1. Хук `useSidebarVisibility`

**Файл:** `src/shared/hooks/useSidebarVisibility.ts`

Хук содержит всю логику для определения видимости Sidebar и решает проблему с гидратацией:

```typescript
export const useSidebarVisibility = () => {
  const pathname = usePathname();
  const [isClient, setIsClient] = useState(false);

  // Обработка гидратации
  useEffect(() => {
    setIsClient(true);
  }, []);

  // Логика показа Sidebar с учетом гидратации
  const shouldShowSidebar =
    isClient && pathname ? showSidebar && !isAuthPage : true; // Показываем по умолчанию при первой отрисовке

  return {
    showSidebar: shouldShowSidebar,
    isAuthPage: isAuthPage || false,
    pathname: pathname || '/',
    isClient,
  };
};
```

### 2. Клиентский компонент `ConditionalSidebarWrapper`

**Файл:** `src/app/ConditionalSidebarWrapper.tsx`

Клиентский компонент использует хук для условного рендеринга Sidebar:

```typescript
'use client';

export function ConditionalSidebarWrapper() {
  const { showSidebar, isClient } = useSidebarVisibility();

  // Показываем Sidebar по умолчанию при первой отрисовке
  if (!isClient) {
    return <Sidebar />;
  }

  return showSidebar ? <Sidebar /> : null;
}
```

### 3. Серверный компонент `layout.tsx`

**Файл:** `src/app/layout.tsx`

Серверный компонент рендерит `ConditionalSidebarWrapper` и может экспортировать `metadata`:

```typescript
// Серверный компонент - может экспортировать metadata
export const metadata: Metadata = { ... };

export default function RootLayout() {
  return (
    // ...
    <ConditionalSidebarWrapper />
    // ...
  );
}
```

## Решение проблемы с гидратацией

### Проблема

При первой отрисовке приложения `usePathname()` возвращает `undefined`, что приводило к тому, что Sidebar не показывался на главной странице.

### Решение

1. **Состояние `isClient`** - отслеживает, когда компонент загружен на клиенте
2. **Fallback логика** - при первой отрисовке показываем Sidebar по умолчанию
3. **Плавный переход** - после гидратации применяется обычная логика условного отображения

### Преимущества решения

- ✅ Sidebar показывается при первой отрисовке
- ✅ Нет мерцания или скачков интерфейса
- ✅ Плавная гидратация без потери функциональности
- ✅ Сохранена вся логика условного отображения

## Почему такая архитектура?

### Проблема Next.js

В Next.js App Router нельзя экспортировать `metadata` из клиентского компонента (с директивой `'use client'`).

### Архитектурное решение

1. **`layout.tsx`** - остается серверным компонентом и может экспортировать `metadata`
2. **`ConditionalSidebarWrapper.tsx`** - клиентский компонент с логикой условного отображения
3. **`useSidebarVisibility`** - хук с бизнес-логикой и решением проблемы гидратации

## Настройка маршрутов

### Текущие маршруты с Sidebar

- `/` - главная страница
- `/profile` - профиль пользователя
- `/search` - поиск

### Маршруты без Sidebar

- Все auth страницы (`/sign-in`, `/sign-up`, etc.)
- Страницы, не указанные в `sidebarRoutes`

### Добавление новых маршрутов

Чтобы добавить новый маршрут для показа Sidebar, отредактируйте массив `sidebarRoutes` в файле `useSidebarVisibility.ts`:

```typescript
const sidebarRoutes = ['/', '/profile', '/search', '/new-page'];
```

## Преимущества новой реализации

1. **Лучший UX** - Sidebar показывается только там, где нужен
2. **Гибкость** - легко настраивать маршруты для показа Sidebar
3. **Чистота кода** - логика вынесена в отдельный хук
4. **Переиспользование** - хук можно использовать в других компонентах
5. **Простота поддержки** - вся логика в одном месте
6. **Совместимость с Next.js** - правильное разделение серверных и клиентских компонентов
7. **Решение проблемы гидратации** - Sidebar корректно отображается при первой загрузке

## Использование в других компонентах

Хук `useSidebarVisibility` можно использовать в любом компоненте для получения информации о текущем состоянии:

```typescript
import { useSidebarVisibility } from '@/shared/hooks';

function MyComponent() {
  const { showSidebar, isAuthPage, pathname, isClient } = useSidebarVisibility();

  // Используйте полученную информацию
  if (!isClient) {
    return <LoadingState />;
  }

  if (isAuthPage) {
    return <AuthContent />;
  }

  return <MainContent />;
}
```

## Будущие улучшения

- [ ] Добавить страницу `/create-post`
- [ ] Добавить страницу `/messenger`
- [ ] Добавить страницу `/statistics`
- [ ] Добавить страницу `/favorites`
- [ ] Возможность динамической настройки маршрутов через конфигурацию
- [ ] Анимации появления/исчезновения Sidebar
- [ ] Оптимизация гидратации для лучшей производительности

## Новые функции

### 1. Состояние загрузки в форме входа

Реализовано улучшение UX для формы входа с показом состояния загрузки:

#### **1. Что добавлено в форму входа:**

- **Спиннер загрузки** - анимированный индикатор процесса
- **Сообщение о процессе** - "Вход в систему..." во время авторизации
- **Блокировка кнопки** - предотвращает повторные нажатия

#### **2. Как это работает в форме входа:**

```tsx
// В хуке useLogInForm добавлено состояние isRedirecting
const [isRedirecting, setIsRedirecting] = useState(false);

// Комбинированное состояние загрузки
const isFormLoading = isLoading || isRedirecting;

// В компоненте кнопки
{
  isLoading ? (
    // Состояние загрузки: спиннер + сообщение (показывается до перехода на профиль)
    <div className="flex items-center justify-center gap-2">
      <Spinner size={16} />
      <span>Вход в систему...</span>
    </div>
  ) : (
    // Обычное состояние: текст кнопки
    'Sign In'
  );
}
```

#### **3. Преимущества формы входа:**

- ✅ **Лучший UX** - пользователь понимает, что процесс идет
- ✅ **Предотвращение спама** - кнопка блокируется во время загрузки
- ✅ **Визуальная обратная связь** - спиннер показывает активность
- ✅ **Информативность** - понятно, что происходит в данный момент

#### **4. Техническая реализация формы входа:**

- Использует существующий хук `useLogInForm` с расширенным состоянием загрузки
- Добавлено состояние `isRedirecting` для отслеживания процесса перехода
- Комбинированное состояние `isFormLoading = isLoading || isRedirecting`
- Компонент `Spinner` из UI библиотеки
- Условный рендеринг на основе состояния загрузки
- Автоматическая блокировка кнопки при `isFormLoading = true`
- Небольшая задержка (500ms) перед редиректом для лучшего UX

### 2. Универсальная кнопка в Sidebar

Реализована универсальная кнопка внизу Sidebar, которая адаптируется к состоянию авторизации:

#### **1. Что добавлено в Sidebar:**

- **Кнопка "Sign In"** - для неавторизованных пользователей
- **Кнопка "Log Out"** - для авторизованных пользователей
- **Адаптивное поведение** - автоматически меняется в зависимости от состояния

#### **2. Как это работает в Sidebar:**

```tsx
{data ? (
  // Для авторизованных пользователей - кнопка выхода
  <>
    <LogoutButton hideText={!isSidebarOpen} openModal={openModal} />
    <LogoutModal ... />
  </>
) : (
  // Для неавторизованных пользователей - кнопка входа
  <Button onClick={() => window.location.href = '/sign-in'}>
    <IconSprite iconName="person-outline" />
    {isSidebarOpen && <span>Sign In</span>}
  </Button>
)}
```

#### **3. Преимущества Sidebar:**

- ✅ **Всегда доступна** - кнопка присутствует независимо от состояния авторизации
- ✅ **Интуитивно понятно** - пользователь всегда знает, как войти или выйти
- ✅ **Единообразие интерфейса** - Sidebar выглядит завершенным
- ✅ **Улучшенная навигация** - быстрый доступ к функциям авторизации

## Адаптация к состоянию авторизации

### 1. Для неавторизованных пользователей

- Sidebar показывается на разрешенных маршрутах
- Нижняя часть Sidebar остается пустой (без кнопки "Выйти" и без дополнительных сообщений)
- Все пункты меню доступны для навигации

### 2. Для авторизованных пользователей

- Полный функционал Sidebar
- Кнопка "Выйти" с модальным окном подтверждения
- Доступ ко всем функциям приложения

### 3. Преимущества такого подхода

- **Лучший UX** - пользователи видят навигацию сразу при загрузке
- **Единообразие интерфейса** - Sidebar присутствует на всех разрешенных страницах
- **Мотивация к регистрации** - неавторизованные пользователи видят, что у приложения есть функционал
- **Плавная интеграция** - после входа функционал автоматически расширяется
