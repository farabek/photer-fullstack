# Журнал изменений

## [2025-09-11] - Исправление логики определения типа userIdentifier, авторизации профилей и отображения постов

### Изменено

- Изменена логика метода `getUserPosts` в `posts.service.ts`: теперь сначала проверяется существование пользователя по `userIdentifier` как `userId`, затем по `username` через профиль
- Убрана зависимость от regex для определения типа идентификатора, что исправляет проблему с CUID форматом userId
- Добавлены подробные логи для отслеживания процесса поиска пользователя
- Изменена логика метода `getProfileById` в `profile.service.ts`: добавлен поиск по `userId` в дополнение к поиску по `username` и `profile.id`
- Улучшена логика поиска профилей для поддержки различных типов идентификаторов
- Исправлена авторизация endpoint `/profile/:id` в `profile.controller.ts`: убран `@UseGuards()` для обеспечения публичного доступа
- Исправлена логика в `usePostsList` хуке: улучшена приоритизация данных (cache > SSR > fallback)
- Добавлены debug логи в frontend компонентах для отслеживания передачи данных
- **Исправлена логика кеширования в `usePostsList.ts`**: предотвращено перезаписывание SSR данных пустым кешем, улучшена проверка существования данных в кеше

### Исправлено

- Исправлена проблема с поиском постов для авторизованного пользователя, когда `userIdentifier` приходит как CUID (userId), а не UUID
- Исправлена проблема с поиском профилей, когда идентификатор приходит как `userId`
- Исправлена проблема с доступом к чужим профилям для авторизованных пользователей (убрана защита guard)
- Исправлена проблема с отображением постов в профилях (улучшена логика обработки SSR и cache данных)
- Улучшена надежность определения типа идентификатора без использования regex
- **Исправлена критическая проблема с исчезновением постов при повторном заходе на страницу профиля** - пустой кеш больше не перезаписывает SSR данные

## [2025-09-11] - Изменение логики приватности профилей

### Изменено (2025-09-11)

- Изменена логика передачи Authorization header в запросе профиля: токен авторизации передаётся только если пользователь является владельцем профиля
- Для авторизованного пользователя, просматривающего чужой профиль с главной страницы, профиль отображается без деталей (как для неавторизованного)
- Исправлена ошибка с отображением имени авторизованного пользователя вместо имени владельца профиля
- Добавлен новый API endpoint `/posts/profiles/{profileId}` для получения постов по ID профиля
- Изменён URL fetch постов в page.tsx на `/posts/profiles/{profileId}`
- Добавлена документация проекта в папку docs/

### Добавлено (2025-09-11)

- Создан файл docs/Project.md с детальным описанием проекта
- Создан файл docs/Tasktracker.md для отслеживания задач
- Создан файл docs/Diary.md для ведения дневника разработки
- Создан файл docs/qa.md с вопросами по архитектуре
- Создан файл docs/codestyle.md с правилами кодстайла
- Добавлен метод `getUserPostsByProfileId` в posts.service.ts
- Добавлен endpoint `GET /posts/profiles/:profileId` в posts.controller.ts

### Исправлено (2025-09-11)

- Улучшена приватность профилей для авторизованных пользователей
- Исправлено отображение постов на странице чужого профиля
- Исправлено отображение имени владельца профиля вместо имени авторизованного пользователя

## [2025-09-18] - Добавление правил контроля операций Git и отладки

### Добавлено (2025-09-18)

- **Agent Guidelines** в AGENTS.md:
  - Правило запрета самостоятельных коммитов/пушей без разрешения пользователя
  - Правило запрета удаления console.log без разрешения пользователя
  - Правило обязательного подтверждения значимых изменений
  - Правило обновления документации перед изменениями
- **Правила работы с Git** в docs/codestyle.md:
  - Запрещенные действия (коммиты, пуши, удаление логов)
  - Разрешенные действия (предложение изменений, документация)
- **Правила работы с отладкой** в docs/codestyle.md:
  - Сохранение console.log для отладки
  - Документация отладочных логов
- **Критически важные правила** в docs/codestyle.md:
  - Строгие ограничения на операции
  - Процесс согласования изменений
- Запись в docs/Diary.md о введении новых правил

### Изменено (2025-09-18)

- Обновлен раздел "Common Pitfalls to Avoid" в AGENTS.md
- Улучшена документация процесса разработки
- Установлен строгий контроль над операциями Git

### Документация (2025-09-18)

- Все правила документированы в соответствующих файлах
- Установлен процесс согласования для будущих изменений
- Создан механизм контроля за соблюдением правил

## [2025-09-18] - Критическое исправление автоматического отображения фотографий после создания поста

### Проблема

Пользователи не видели загруженные фотографии сразу после создания поста - требовалась ручная перезагрузка страницы.

### Решенные проблемы

#### 1. Отсутствующий placeholder.svg

- **Проблема:** Компонент `PhotoPreviewWithNav` пытался загрузить несуществующий файл `/placeholder.svg`
- **Решение:** Создан простой SVG placeholder в `photer-app-dev/public/placeholder.svg`

#### 2. Неправильная раздача статических файлов

- **Проблема:** Файлы загружались в `uploads/`, но HTTP-запросы возвращали 404 Not Found
- **Решение:** Исправлен путь в `photer-api-dev/apps/gateway/src/main.ts`:

  ```typescript
  // Было: join(__dirname, '../../uploads')
  // Стало: join(__dirname, '../../../uploads')
  ```

#### 3. Неправильный порядок установки флага `postCreated`

- **Проблема:** Флаг `setPostCreated(true)` вызывался ДО `resetState()`, который сбрасывал весь state
- **Решение:** Изменен порядок в `usePostDescription.ts`:

  ```typescript
  // Было: setPostCreated(true) → resetState()
  // Стало: resetState() → setPostCreated(true)
  ```

#### 4. Неправильная логика приоритетов в `usePostsList`

- **Проблема:** SSR данные устанавливались первыми, кэш приходил позже, но SSR данные имели приоритет
- **Решение:** Переписана логика приоритетов:
  - Кэш имеет приоритет над SSR данными
  - SSR данные игнорируются если `postCreated = true`
  - Пустой кэш используется для очистки старых данных

#### 5. Несуществующий метод `refetchTags`

- **Проблема:** Использовался несуществующий метод `postsApi.util.refetchTags()`
- **Решение:** Удален несуществующий метод, используется только `invalidateTags(['Posts'])`

#### 6. Недостаточная инвалидация кэша

- **Проблема:** Кэш не обновлялся полностью после создания поста
- **Решение:** Добавлена многоуровневая инвалидация:

  ```typescript
  dispatch(postsApi.util.invalidateTags(['Posts']));
  dispatch(
    postsApi.util.invalidateTags([{ type: 'Posts', id: 'PROFILE_POSTS_LIST' }]),
  );
  ```

#### 7. Отсутствие принудительного обновления кэша

- **Проблема:** Инвалидация кэша не гарантировала получение свежих данных
- **Решение:** Добавлен принудительный запрос:

  ```typescript
  if (profileId) {
    getProfilePosts({ profileId, pageNumber: 1 });
  }
  ```

#### 8. Неправильное получение `profileId` из Redux state

- **Проблема:** `state.auth.user?.id` не существует в структуре Redux state
- **Решение:** Исправлено получение `profileId`:

  ```typescript
  // Было: state.auth.user?.id
  // Стало: authApi.endpoints.getMe.select()(state).data?.userId
  ```

### Изменено (2025-09-18) - Файлы кода

- `photer-app-dev/src/features/posts/model/postSlice.ts` - добавлен флаг `postCreated`
- `photer-app-dev/src/features/posts/lib/post.types.ts` - обновлены типы для поддержки флага
- `photer-app-dev/src/features/posts/hooks/create/usePostDescription.ts` - исправлена логика создания поста
- `photer-app-dev/src/features/posts/hooks/feed/usePostsList.ts` - переписана логика приоритетов
- `photer-api-dev/apps/gateway/src/main.ts` - исправлен путь статических файлов

### Добавлено (2025-09-18) - Новые функции

- `photer-app-dev/public/placeholder.svg` - создан placeholder для изображений
- Система флагов в Redux для отслеживания состояния создания поста
- Многоуровневая инвалидация кэша
- Принудительное обновление данных после создания поста
- Подробные отладочные логи для диагностики

### Исправлено (2025-09-18)

- **Критическая проблема:** Фото теперь появляются автоматически сразу после создания поста без необходимости ручной перезагрузки страницы
- Исправлена раздача статических файлов
- Исправлена логика приоритетов между кэшем и SSR данными
- Исправлена инвалидация и обновление кэша
- Исправлено получение данных пользователя из Redux state

### Архитектурные улучшения

- Улучшена система кэширования с правильными приоритетами
- Добавлена система флагов для отслеживания состояния
- Улучшена отладочная система с подробными логами
- Установлены правильные зависимости между компонентами
